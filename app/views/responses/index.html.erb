<%# Total Counter %>
<div class="px-4 py-3 text-sm text-gray-600 border-b">
  <% totals = @submissions_by_role || @survey.submissions.group(:role_id).count %>

  <% Role.where(id: totals.keys.compact).order(:role).each do |r| %>
    <span class="mr-4">
      <strong><%= r.role %>:</strong> <%= totals[r.id] %>
    </span>
  <% end %>

  <% if totals[nil] %>
    <span class="mr-4">
      <strong>Unspecified:</strong> <%= totals[nil] %>
    </span>
  <% end %>

  <span class="ml-4 text-gray-500">
    Total submissions: <%= totals.values.sum %>
  </span>
</div>

<%# Filter %>
<div class="flex items-center gap-2 mb-3 mt-6">
  <%= role_filter_button("All",
        survey_responses_path(@survey),
        active: @current_role_id.nil?) %>

  <% @roles.each do |r| %>
    <%= role_filter_button(r.role,
          survey_responses_path(@survey, role_id: r.id),
          active: @current_role_id.to_s == r.id.to_s) %>
  <% end %>
</div>

<% if @current_role_id.present? %>
  <div class="text-xs text-gray-500 mb-4">
    Showing submissions for:
    <strong>
      <%= @roles.find { |r| r.id.to_s == @current_role_id.to_s }&.role || "Unknown" %>
    </strong>
    · <%= link_to "Clear", survey_responses_path(@survey), class: "underline hover:no-underline" %>
  </div>
<% end %>

<%# Responses %>
<div class="space-y-6 mt-6">
  <% if @submissions.any? %>
    <% @submissions.each do |sub| %>
      <div class="bg-white shadow rounded">
        <div class="flex items-center justify-between px-4 py-3 border-b">
          <div class="text-sm text-gray-700">
            <strong>Submission #<%= sub.id %></strong>
            — Role: <%= sub.role&.role || "Unknown" %>
          </div>
          <div class="text-xs text-gray-500">
            <%= sub.created_at.in_time_zone.strftime("%Y-%m-%d %H:%M") %>
          </div>
        </div>

        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Question</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Answer</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-100">
            <% sub.responses.each do |r| %>
              <tr>
                <td class="px-4 py-2 text-sm text-gray-900"><%= r.question&.content || "Question ##{r.question_id}" %></td>
                <td class="px-4 py-2 text-sm text-gray-700 whitespace-pre-wrap"><%= r.value %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  <% else %>
    <div class="bg-gray-50 border border-gray-200 rounded p-6 text-center text-gray-600">
      No responses have been submitted for this survey yet.
      <div class="mt-3">
        <%= link_to "Take Survey", take_survey_path(@survey),
          class: "inline-flex items-center px-3 py-1 text-sm font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200" %>
      </div>
    </div>
  <% end %>
</div>
